<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AlertService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RetrouvTout Backend</a> &gt; <a href="index.source.html" class="el_package">com.retrouvtout.service</a> &gt; <span class="el_source">AlertService.java</span></div><h1>AlertService.java</h1><pre class="source lang-java linenums">package com.retrouvtout.service;

import com.retrouvtout.dto.request.CreateAlertRequest;
import com.retrouvtout.dto.response.AlertResponse;
import com.retrouvtout.entity.Alert;
import com.retrouvtout.entity.Listing;
import com.retrouvtout.entity.User;
import com.retrouvtout.exception.ResourceNotFoundException;
import com.retrouvtout.repository.AlertRepository;
import com.retrouvtout.repository.UserRepository;
import com.retrouvtout.util.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;

/**
 * Service pour la gestion des alertes d'objets perdus
 */
@Service
@Transactional
public class AlertService {

    private final AlertRepository alertRepository;
    private final UserRepository userRepository;
    private final ModelMapper modelMapper;
    private final EmailService emailService;
    private final SmsService smsService;
    private final NotificationService notificationService;

    @Autowired
    public AlertService(AlertRepository alertRepository,
                       UserRepository userRepository,
                       ModelMapper modelMapper,
                       EmailService emailService,
                       SmsService smsService,
<span class="nc" id="L43">                       NotificationService notificationService) {</span>
<span class="nc" id="L44">        this.alertRepository = alertRepository;</span>
<span class="nc" id="L45">        this.userRepository = userRepository;</span>
<span class="nc" id="L46">        this.modelMapper = modelMapper;</span>
<span class="nc" id="L47">        this.emailService = emailService;</span>
<span class="nc" id="L48">        this.smsService = smsService;</span>
<span class="nc" id="L49">        this.notificationService = notificationService;</span>
<span class="nc" id="L50">    }</span>

    /**
     * Créer une nouvelle alerte
     */
    public AlertResponse createAlert(CreateAlertRequest request, String userId) {
<span class="nc" id="L56">        User user = userRepository.findByIdAndActiveTrue(userId)</span>
<span class="nc" id="L57">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Utilisateur&quot;, &quot;id&quot;, userId));</span>

<span class="nc" id="L59">        Alert alert = new Alert();</span>
<span class="nc" id="L60">        alert.setId(java.util.UUID.randomUUID().toString());</span>
<span class="nc" id="L61">        alert.setOwnerUser(user);</span>
<span class="nc" id="L62">        alert.setTitle(request.getTitle());</span>
<span class="nc" id="L63">        alert.setQueryText(request.getQueryText());</span>
<span class="nc" id="L64">        alert.setCategory(request.getCategory());</span>
<span class="nc" id="L65">        alert.setLocationText(request.getLocationText());</span>
<span class="nc" id="L66">        alert.setLatitude(request.getLatitude());</span>
<span class="nc" id="L67">        alert.setLongitude(request.getLongitude());</span>
<span class="nc" id="L68">        alert.setRadiusKm(request.getRadiusKm());</span>
<span class="nc" id="L69">        alert.setDateFrom(request.getDateFrom());</span>
<span class="nc" id="L70">        alert.setDateTo(request.getDateTo());</span>
<span class="nc" id="L71">        alert.setChannels(request.getChannels());</span>
<span class="nc" id="L72">        alert.setActive(true);</span>

<span class="nc" id="L74">        Alert savedAlert = alertRepository.save(alert);</span>
<span class="nc" id="L75">        return modelMapper.mapAlertToAlertResponse(savedAlert);</span>
    }

    /**
     * Obtenir les alertes d'un utilisateur
     */
    @Transactional(readOnly = true)
    public Page&lt;AlertResponse&gt; getUserAlerts(String userId, Pageable pageable) {
<span class="nc" id="L83">        User user = userRepository.findByIdAndActiveTrue(userId)</span>
<span class="nc" id="L84">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Utilisateur&quot;, &quot;id&quot;, userId));</span>

<span class="nc" id="L86">        Page&lt;Alert&gt; alerts = alertRepository.findByOwnerUserAndActiveTrueOrderByCreatedAtDesc(user, pageable);</span>
<span class="nc" id="L87">        return alerts.map(modelMapper::mapAlertToAlertResponse);</span>
    }

    /**
     * Obtenir une alerte par son ID
     */
    @Transactional(readOnly = true)
    public AlertResponse getAlertById(String id, String userId) {
<span class="nc" id="L95">        Alert alert = alertRepository.findById(id)</span>
<span class="nc" id="L96">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Alerte&quot;, &quot;id&quot;, id));</span>

        // Vérifier que l'utilisateur est propriétaire de l'alerte
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (!alert.getOwnerUser().getId().equals(userId)) {</span>
<span class="nc" id="L100">            throw new SecurityException(&quot;Vous n'êtes pas autorisé à accéder à cette alerte&quot;);</span>
        }

<span class="nc" id="L103">        return modelMapper.mapAlertToAlertResponse(alert);</span>
    }

    /**
     * Mettre à jour une alerte
     */
    public AlertResponse updateAlert(String id, CreateAlertRequest request, String userId) {
<span class="nc" id="L110">        Alert alert = alertRepository.findById(id)</span>
<span class="nc" id="L111">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Alerte&quot;, &quot;id&quot;, id));</span>

        // Vérifier que l'utilisateur est propriétaire de l'alerte
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (!alert.getOwnerUser().getId().equals(userId)) {</span>
<span class="nc" id="L115">            throw new SecurityException(&quot;Vous n'êtes pas autorisé à modifier cette alerte&quot;);</span>
        }

        // Mettre à jour les champs
<span class="nc" id="L119">        alert.setTitle(request.getTitle());</span>
<span class="nc" id="L120">        alert.setQueryText(request.getQueryText());</span>
<span class="nc" id="L121">        alert.setCategory(request.getCategory());</span>
<span class="nc" id="L122">        alert.setLocationText(request.getLocationText());</span>
<span class="nc" id="L123">        alert.setLatitude(request.getLatitude());</span>
<span class="nc" id="L124">        alert.setLongitude(request.getLongitude());</span>
<span class="nc" id="L125">        alert.setRadiusKm(request.getRadiusKm());</span>
<span class="nc" id="L126">        alert.setDateFrom(request.getDateFrom());</span>
<span class="nc" id="L127">        alert.setDateTo(request.getDateTo());</span>
<span class="nc" id="L128">        alert.setChannels(request.getChannels());</span>

<span class="nc" id="L130">        Alert updatedAlert = alertRepository.save(alert);</span>
<span class="nc" id="L131">        return modelMapper.mapAlertToAlertResponse(updatedAlert);</span>
    }

    /**
     * Supprimer une alerte
     */
    public void deleteAlert(String id, String userId) {
<span class="nc" id="L138">        Alert alert = alertRepository.findById(id)</span>
<span class="nc" id="L139">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Alerte&quot;, &quot;id&quot;, id));</span>

        // Vérifier que l'utilisateur est propriétaire de l'alerte
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (!alert.getOwnerUser().getId().equals(userId)) {</span>
<span class="nc" id="L143">            throw new SecurityException(&quot;Vous n'êtes pas autorisé à supprimer cette alerte&quot;);</span>
        }

<span class="nc" id="L146">        alertRepository.delete(alert);</span>
<span class="nc" id="L147">    }</span>

    /**
     * Activer/désactiver une alerte
     */
    public AlertResponse toggleAlert(String id, String userId) {
<span class="nc" id="L153">        Alert alert = alertRepository.findById(id)</span>
<span class="nc" id="L154">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Alerte&quot;, &quot;id&quot;, id));</span>

        // Vérifier que l'utilisateur est propriétaire de l'alerte
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (!alert.getOwnerUser().getId().equals(userId)) {</span>
<span class="nc" id="L158">            throw new SecurityException(&quot;Vous n'êtes pas autorisé à modifier cette alerte&quot;);</span>
        }

<span class="nc bnc" id="L161" title="All 2 branches missed.">        alert.setActive(!alert.getActive());</span>
<span class="nc" id="L162">        Alert updatedAlert = alertRepository.save(alert);</span>
        
<span class="nc" id="L164">        return modelMapper.mapAlertToAlertResponse(updatedAlert);</span>
    }

    /**
     * Vérifier et notifier les alertes correspondantes pour une nouvelle annonce
     */
    @Async
    public void checkAndNotifyMatchingAlerts(Listing listing) {
<span class="nc" id="L172">        List&lt;Alert&gt; activeAlerts = alertRepository.findByActiveTrue();</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">        for (Alert alert : activeAlerts) {</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">            if (isListingMatchingAlert(listing, alert)) {</span>
                // Marquer l'alerte comme déclenchée
<span class="nc" id="L177">                alert.setLastTriggeredAt(LocalDateTime.now());</span>
<span class="nc" id="L178">                alertRepository.save(alert);</span>

                // Envoyer les notifications selon les canaux configurés
<span class="nc" id="L181">                sendAlertNotifications(alert, listing);</span>
            }
<span class="nc" id="L183">        }</span>
<span class="nc" id="L184">    }</span>

    /**
     * Vérifier si une annonce correspond à une alerte
     */
    private boolean isListingMatchingAlert(Listing listing, Alert alert) {
        // Vérifier la catégorie
<span class="nc bnc" id="L191" title="All 4 branches missed.">        if (alert.getCategory() != null &amp;&amp; !alert.getCategory().trim().isEmpty()) {</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">            if (!listing.getCategory().getValue().equalsIgnoreCase(alert.getCategory())) {</span>
<span class="nc" id="L193">                return false;</span>
            }
        }

        // Vérifier le texte de recherche
<span class="nc bnc" id="L198" title="All 4 branches missed.">        if (alert.getQueryText() != null &amp;&amp; !alert.getQueryText().trim().isEmpty()) {</span>
<span class="nc" id="L199">            String query = alert.getQueryText().toLowerCase();</span>
<span class="nc" id="L200">            String title = listing.getTitle().toLowerCase();</span>
<span class="nc" id="L201">            String description = listing.getDescription().toLowerCase();</span>
            
<span class="nc bnc" id="L203" title="All 4 branches missed.">            if (!title.contains(query) &amp;&amp; !description.contains(query)) {</span>
<span class="nc" id="L204">                return false;</span>
            }
        }

        // Vérifier la localisation
<span class="nc bnc" id="L209" title="All 4 branches missed.">        if (alert.getLocationText() != null &amp;&amp; !alert.getLocationText().trim().isEmpty()) {</span>
<span class="nc" id="L210">            String alertLocation = alert.getLocationText().toLowerCase();</span>
<span class="nc" id="L211">            String listingLocation = listing.getLocationText().toLowerCase();</span>
            
<span class="nc bnc" id="L213" title="All 2 branches missed.">            if (!listingLocation.contains(alertLocation)) {</span>
<span class="nc" id="L214">                return false;</span>
            }
        }

        // Vérifier la proximité géographique
<span class="nc bnc" id="L219" title="All 4 branches missed.">        if (alert.getLatitude() != null &amp;&amp; alert.getLongitude() != null &amp;&amp;</span>
<span class="nc bnc" id="L220" title="All 4 branches missed.">            listing.getLatitude() != null &amp;&amp; listing.getLongitude() != null) {</span>
            
<span class="nc" id="L222">            double distance = calculateDistance(</span>
<span class="nc" id="L223">                alert.getLatitude().doubleValue(), alert.getLongitude().doubleValue(),</span>
<span class="nc" id="L224">                listing.getLatitude().doubleValue(), listing.getLongitude().doubleValue()</span>
            );
            
<span class="nc bnc" id="L227" title="All 2 branches missed.">            double radiusKm = alert.getRadiusKm() != null ? alert.getRadiusKm().doubleValue() : 10.0;</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (distance &gt; radiusKm) {</span>
<span class="nc" id="L229">                return false;</span>
            }
        }

        // Vérifier les dates
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (alert.getDateFrom() != null) {</span>
<span class="nc" id="L235">            LocalDateTime dateFrom = alert.getDateFrom().atStartOfDay();</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">            if (listing.getFoundAt().isBefore(dateFrom)) {</span>
<span class="nc" id="L237">                return false;</span>
            }
        }

<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (alert.getDateTo() != null) {</span>
<span class="nc" id="L242">            LocalDateTime dateTo = alert.getDateTo().atTime(23, 59, 59);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">            if (listing.getFoundAt().isAfter(dateTo)) {</span>
<span class="nc" id="L244">                return false;</span>
            }
        }

<span class="nc" id="L248">        return true;</span>
    }

    /**
     * Calculer la distance entre deux points géographiques (formule de Haversine)
     */
    private double calculateDistance(double lat1, double lon1, double lat2, double lon2) {
<span class="nc" id="L255">        final int R = 6371; // Rayon de la Terre en kilomètres</span>

<span class="nc" id="L257">        double latDistance = Math.toRadians(lat2 - lat1);</span>
<span class="nc" id="L258">        double lonDistance = Math.toRadians(lon2 - lon1);</span>
        
<span class="nc" id="L260">        double a = Math.sin(latDistance / 2) * Math.sin(latDistance / 2)</span>
<span class="nc" id="L261">                + Math.cos(Math.toRadians(lat1)) * Math.cos(Math.toRadians(lat2))</span>
<span class="nc" id="L262">                * Math.sin(lonDistance / 2) * Math.sin(lonDistance / 2);</span>
        
<span class="nc" id="L264">        double c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));</span>
        
<span class="nc" id="L266">        return R * c;</span>
    }

    /**
     * Envoyer les notifications pour une alerte déclenchée
     */
    private void sendAlertNotifications(Alert alert, Listing listing) {
<span class="nc" id="L273">        User user = alert.getOwnerUser();</span>
<span class="nc" id="L274">        String listingUrl = &quot;http://localhost:3000/annonces/&quot; + listing.getId();</span>

        // Notifications email
<span class="nc bnc" id="L277" title="All 4 branches missed.">        if (alert.getChannels().contains(&quot;email&quot;) &amp;&amp; user.getEmailVerified()) {</span>
<span class="nc" id="L278">            emailService.sendAlertNotification(</span>
<span class="nc" id="L279">                user, alert.getTitle(), listing.getTitle(), listingUrl);</span>
        }

        // Notifications SMS
<span class="nc bnc" id="L283" title="All 4 branches missed.">        if (alert.getChannels().contains(&quot;sms&quot;) &amp;&amp; user.getPhone() != null) {</span>
<span class="nc" id="L284">            String message = String.format(</span>
                &quot;Retrouv'Tout: Nouvel objet trouvé pour votre alerte '%s' - %s. Voir: %s&quot;,
<span class="nc" id="L286">                alert.getTitle(), listing.getTitle(), listingUrl</span>
            );
<span class="nc" id="L288">            smsService.sendSms(user.getPhone(), message);</span>
        }

        // Notifications push
<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (alert.getChannels().contains(&quot;push&quot;)) {</span>
<span class="nc" id="L293">            notificationService.sendPushNotification(</span>
<span class="nc" id="L294">                user.getId(),</span>
                &quot;Nouvel objet trouvé !&quot;,
<span class="nc" id="L296">                String.format(&quot;L'objet '%s' correspond à votre alerte '%s'&quot;, </span>
<span class="nc" id="L297">                    listing.getTitle(), alert.getTitle()),</span>
                listingUrl
            );
        }
<span class="nc" id="L301">    }</span>

    /**
     * Obtenir les statistiques des alertes pour un utilisateur
     */
    @Transactional(readOnly = true)
    public long getUserActiveAlertsCount(String userId) {
<span class="nc" id="L308">        User user = userRepository.findByIdAndActiveTrue(userId)</span>
<span class="nc" id="L309">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Utilisateur&quot;, &quot;id&quot;, userId));</span>

<span class="nc" id="L311">        return alertRepository.countByOwnerUserAndActiveTrue(user);</span>
    }

    /**
     * Obtenir les alertes récemment déclenchées
     */
    @Transactional(readOnly = true)
    public Page&lt;AlertResponse&gt; getRecentlyTriggeredAlerts(String userId, Pageable pageable) {
<span class="nc" id="L319">        User user = userRepository.findByIdAndActiveTrue(userId)</span>
<span class="nc" id="L320">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Utilisateur&quot;, &quot;id&quot;, userId));</span>

<span class="nc" id="L322">        Page&lt;Alert&gt; alerts = alertRepository.findByOwnerUserAndLastTriggeredAtIsNotNullOrderByLastTriggeredAtDesc(</span>
            user, pageable);
        
<span class="nc" id="L325">        return alerts.map(modelMapper::mapAlertToAlertResponse);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>