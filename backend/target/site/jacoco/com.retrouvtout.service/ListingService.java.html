<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ListingService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RetrouvTout Backend</a> &gt; <a href="index.source.html" class="el_package">com.retrouvtout.service</a> &gt; <span class="el_source">ListingService.java</span></div><h1>ListingService.java</h1><pre class="source lang-java linenums">package com.retrouvtout.service;

import com.retrouvtout.dto.request.CreateListingRequest;
import com.retrouvtout.dto.request.UpdateListingRequest;
import com.retrouvtout.dto.response.ListingResponse;
import com.retrouvtout.entity.Listing;
import com.retrouvtout.entity.User;
import com.retrouvtout.exception.ResourceNotFoundException;
import com.retrouvtout.repository.ListingRepository;
import com.retrouvtout.repository.UserRepository;
import com.retrouvtout.util.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cache.annotation.CacheEvict;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

/**
 * Service pour la gestion des annonces d'objets retrouvés
 */
@Service
@Transactional
public class ListingService {

    private final ListingRepository listingRepository;
    private final UserRepository userRepository;
    private final ModelMapper modelMapper;
    private final NotificationService notificationService;
    private final AlertService alertService;

    @Autowired
    public ListingService(ListingRepository listingRepository,
                         UserRepository userRepository,
                         ModelMapper modelMapper,
                         NotificationService notificationService,
<span class="nc" id="L45">                         AlertService alertService) {</span>
<span class="nc" id="L46">        this.listingRepository = listingRepository;</span>
<span class="nc" id="L47">        this.userRepository = userRepository;</span>
<span class="nc" id="L48">        this.modelMapper = modelMapper;</span>
<span class="nc" id="L49">        this.notificationService = notificationService;</span>
<span class="nc" id="L50">        this.alertService = alertService;</span>
<span class="nc" id="L51">    }</span>

    /**
     * Rechercher des annonces avec filtres
     */
    @Transactional(readOnly = true)
    public Page&lt;ListingResponse&gt; searchListings(String query, String category, String location,
                                               BigDecimal lat, BigDecimal lng, Double radiusKm,
                                               LocalDate dateFrom, LocalDate dateTo,
                                               Pageable pageable) {
        
<span class="nc" id="L62">        Specification&lt;Listing&gt; spec = Specification.where(null);</span>

        // Filtre par statut actif uniquement
<span class="nc" id="L65">        spec = spec.and((root, query1, cb) -&gt; </span>
<span class="nc" id="L66">            cb.equal(root.get(&quot;status&quot;), Listing.ListingStatus.ACTIVE));</span>

        // Filtre par modération (afficher seulement les annonces modérées)
<span class="nc" id="L69">        spec = spec.and((root, query1, cb) -&gt; </span>
<span class="nc" id="L70">            cb.equal(root.get(&quot;isModerated&quot;), true));</span>

        // Filtre par mot-clé
<span class="nc bnc" id="L73" title="All 4 branches missed.">        if (query != null &amp;&amp; !query.trim().isEmpty()) {</span>
<span class="nc" id="L74">            spec = spec.and((root, query1, cb) -&gt; </span>
<span class="nc" id="L75">                cb.or(</span>
<span class="nc" id="L76">                    cb.like(cb.lower(root.get(&quot;title&quot;)), &quot;%&quot; + query.toLowerCase() + &quot;%&quot;),</span>
<span class="nc" id="L77">                    cb.like(cb.lower(root.get(&quot;description&quot;)), &quot;%&quot; + query.toLowerCase() + &quot;%&quot;)</span>
                ));
        }

        // Filtre par catégorie
<span class="nc bnc" id="L82" title="All 4 branches missed.">        if (category != null &amp;&amp; !category.trim().isEmpty()) {</span>
<span class="nc" id="L83">            spec = spec.and((root, query1, cb) -&gt; </span>
<span class="nc" id="L84">                cb.equal(root.get(&quot;category&quot;), Listing.ListingCategory.fromValue(category)));</span>
        }

        // Filtre par lieu
<span class="nc bnc" id="L88" title="All 4 branches missed.">        if (location != null &amp;&amp; !location.trim().isEmpty()) {</span>
<span class="nc" id="L89">            spec = spec.and((root, query1, cb) -&gt; </span>
<span class="nc" id="L90">                cb.like(cb.lower(root.get(&quot;locationText&quot;)), &quot;%&quot; + location.toLowerCase() + &quot;%&quot;));</span>
        }

        // Filtre géographique
<span class="nc bnc" id="L94" title="All 6 branches missed.">        if (lat != null &amp;&amp; lng != null &amp;&amp; radiusKm != null) {</span>
<span class="nc" id="L95">            spec = spec.and((root, query1, cb) -&gt; {</span>
                // Utilisation de la formule de Haversine pour calculer la distance
<span class="nc" id="L97">                return cb.lessThanOrEqualTo(</span>
<span class="nc" id="L98">                    cb.function(&quot;ST_Distance_Sphere&quot;,</span>
                        Double.class,
<span class="nc" id="L100">                        cb.function(&quot;POINT&quot;, Object.class, root.get(&quot;longitude&quot;), root.get(&quot;latitude&quot;)),</span>
<span class="nc" id="L101">                        cb.function(&quot;POINT&quot;, Object.class, cb.literal(lng), cb.literal(lat))</span>
                    ),
<span class="nc" id="L103">                    radiusKm * 1000 // Conversion en mètres</span>
                );
            });
        }

        // Filtre par date
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (dateFrom != null) {</span>
<span class="nc" id="L110">            LocalDateTime dateTimeFrom = dateFrom.atStartOfDay();</span>
<span class="nc" id="L111">            spec = spec.and((root, query1, cb) -&gt; </span>
<span class="nc" id="L112">                cb.greaterThanOrEqualTo(root.get(&quot;foundAt&quot;), dateTimeFrom));</span>
        }

<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (dateTo != null) {</span>
<span class="nc" id="L116">            LocalDateTime dateTimeTo = dateTo.atTime(23, 59, 59);</span>
<span class="nc" id="L117">            spec = spec.and((root, query1, cb) -&gt; </span>
<span class="nc" id="L118">                cb.lessThanOrEqualTo(root.get(&quot;foundAt&quot;), dateTimeTo));</span>
        }

<span class="nc" id="L121">        Page&lt;Listing&gt; listings = listingRepository.findAll(spec, pageable);</span>
<span class="nc" id="L122">        return listings.map(modelMapper::mapListingToListingResponse);</span>
    }

    /**
     * Obtenir une annonce par son ID
     */
    @Transactional(readOnly = true)
    @Cacheable(value = &quot;listings&quot;, key = &quot;#id&quot;)
    public ListingResponse getListingById(String id) {
<span class="nc" id="L131">        Listing listing = listingRepository.findById(id)</span>
<span class="nc" id="L132">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Annonce&quot;, &quot;id&quot;, id));</span>
        
<span class="nc" id="L134">        return modelMapper.mapListingToListingResponse(listing);</span>
    }

    /**
     * Créer une nouvelle annonce
     */
    @CacheEvict(value = &quot;listings&quot;, allEntries = true)
    public ListingResponse createListing(CreateListingRequest request, String userId) {
<span class="nc" id="L142">        User user = userRepository.findByIdAndActiveTrue(userId)</span>
<span class="nc" id="L143">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Utilisateur&quot;, &quot;id&quot;, userId));</span>

<span class="nc" id="L145">        Listing listing = new Listing();</span>
<span class="nc" id="L146">        listing.setId(java.util.UUID.randomUUID().toString());</span>
<span class="nc" id="L147">        listing.setFinderUser(user);</span>
<span class="nc" id="L148">        listing.setTitle(request.getTitle());</span>
<span class="nc" id="L149">        listing.setCategory(Listing.ListingCategory.fromValue(request.getCategory()));</span>
<span class="nc" id="L150">        listing.setLocationText(request.getLocationText());</span>
<span class="nc" id="L151">        listing.setLatitude(request.getLatitude());</span>
<span class="nc" id="L152">        listing.setLongitude(request.getLongitude());</span>
<span class="nc" id="L153">        listing.setFoundAt(request.getFoundAt());</span>
<span class="nc" id="L154">        listing.setDescription(request.getDescription());</span>
<span class="nc" id="L155">        listing.setImageUrl(request.getImageUrl());</span>
<span class="nc" id="L156">        listing.setStatus(Listing.ListingStatus.ACTIVE);</span>
<span class="nc" id="L157">        listing.setIsModerated(true); // Auto-approuvé pour l'instant</span>

<span class="nc" id="L159">        Listing savedListing = listingRepository.save(listing);</span>

        // Notifier les utilisateurs avec des alertes correspondantes
<span class="nc" id="L162">        alertService.checkAndNotifyMatchingAlerts(savedListing);</span>

<span class="nc" id="L164">        return modelMapper.mapListingToListingResponse(savedListing);</span>
    }

    /**
     * Mettre à jour une annonce
     */
    @CacheEvict(value = &quot;listings&quot;, key = &quot;#id&quot;)
    public ListingResponse updateListing(String id, UpdateListingRequest request, String userId) {
<span class="nc" id="L172">        Listing listing = listingRepository.findById(id)</span>
<span class="nc" id="L173">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Annonce&quot;, &quot;id&quot;, id));</span>

        // Vérifier que l'utilisateur est le propriétaire de l'annonce
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (!listing.getFinderUser().getId().equals(userId)) {</span>
<span class="nc" id="L177">            throw new SecurityException(&quot;Vous n'êtes pas autorisé à modifier cette annonce&quot;);</span>
        }

        // Mettre à jour les champs
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (request.getTitle() != null) {</span>
<span class="nc" id="L182">            listing.setTitle(request.getTitle());</span>
        }
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (request.getCategory() != null) {</span>
<span class="nc" id="L185">            listing.setCategory(Listing.ListingCategory.fromValue(request.getCategory()));</span>
        }
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (request.getLocationText() != null) {</span>
<span class="nc" id="L188">            listing.setLocationText(request.getLocationText());</span>
        }
<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (request.getLatitude() != null) {</span>
<span class="nc" id="L191">            listing.setLatitude(request.getLatitude());</span>
        }
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (request.getLongitude() != null) {</span>
<span class="nc" id="L194">            listing.setLongitude(request.getLongitude());</span>
        }
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (request.getFoundAt() != null) {</span>
<span class="nc" id="L197">            listing.setFoundAt(request.getFoundAt());</span>
        }
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (request.getDescription() != null) {</span>
<span class="nc" id="L200">            listing.setDescription(request.getDescription());</span>
        }
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (request.getImageUrl() != null) {</span>
<span class="nc" id="L203">            listing.setImageUrl(request.getImageUrl());</span>
        }
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (request.getStatus() != null) {</span>
<span class="nc" id="L206">            listing.setStatus(Listing.ListingStatus.fromValue(request.getStatus()));</span>
        }

<span class="nc" id="L209">        Listing updatedListing = listingRepository.save(listing);</span>
<span class="nc" id="L210">        return modelMapper.mapListingToListingResponse(updatedListing);</span>
    }

    /**
     * Supprimer une annonce
     */
    @CacheEvict(value = &quot;listings&quot;, key = &quot;#id&quot;)
    public void deleteListing(String id, String userId) {
<span class="nc" id="L218">        Listing listing = listingRepository.findById(id)</span>
<span class="nc" id="L219">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Annonce&quot;, &quot;id&quot;, id));</span>

        // Vérifier que l'utilisateur est le propriétaire de l'annonce
<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (!listing.getFinderUser().getId().equals(userId)) {</span>
<span class="nc" id="L223">            throw new SecurityException(&quot;Vous n'êtes pas autorisé à supprimer cette annonce&quot;);</span>
        }

        // Soft delete en changeant le statut
<span class="nc" id="L227">        listing.setStatus(Listing.ListingStatus.SUPPRIME);</span>
<span class="nc" id="L228">        listingRepository.save(listing);</span>
<span class="nc" id="L229">    }</span>

    /**
     * Marquer une annonce comme résolue
     */
    @CacheEvict(value = &quot;listings&quot;, key = &quot;#id&quot;)
    public ListingResponse resolveListing(String id, String userId) {
<span class="nc" id="L236">        Listing listing = listingRepository.findById(id)</span>
<span class="nc" id="L237">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Annonce&quot;, &quot;id&quot;, id));</span>

        // Vérifier que l'utilisateur est le propriétaire de l'annonce
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (!listing.getFinderUser().getId().equals(userId)) {</span>
<span class="nc" id="L241">            throw new SecurityException(&quot;Vous n'êtes pas autorisé à modifier cette annonce&quot;);</span>
        }

<span class="nc" id="L244">        listing.setStatus(Listing.ListingStatus.RESOLU);</span>
<span class="nc" id="L245">        Listing resolvedListing = listingRepository.save(listing);</span>

<span class="nc" id="L247">        return modelMapper.mapListingToListingResponse(resolvedListing);</span>
    }

    /**
     * Obtenir les annonces d'un utilisateur
     */
    @Transactional(readOnly = true)
    public Page&lt;ListingResponse&gt; getUserListings(String userId, String status, Pageable pageable) {
<span class="nc" id="L255">        User user = userRepository.findByIdAndActiveTrue(userId)</span>
<span class="nc" id="L256">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Utilisateur&quot;, &quot;id&quot;, userId));</span>

        Page&lt;Listing&gt; listings;
        
<span class="nc bnc" id="L260" title="All 4 branches missed.">        if (status != null &amp;&amp; !status.trim().isEmpty()) {</span>
<span class="nc" id="L261">            Listing.ListingStatus listingStatus = Listing.ListingStatus.fromValue(status);</span>
<span class="nc" id="L262">            listings = listingRepository.findByFinderUserAndStatusOrderByCreatedAtDesc(</span>
                user, listingStatus, pageable);
<span class="nc" id="L264">        } else {</span>
<span class="nc" id="L265">            listings = listingRepository.findByFinderUserAndStatusNotOrderByCreatedAtDesc(</span>
                user, Listing.ListingStatus.SUPPRIME, pageable);
        }

<span class="nc" id="L269">        return listings.map(modelMapper::mapListingToListingResponse);</span>
    }

    /**
     * Obtenir des annonces similaires
     */
    @Transactional(readOnly = true)
    public List&lt;ListingResponse&gt; getSimilarListings(String id, int limit) {
<span class="nc" id="L277">        Listing referenceListing = listingRepository.findById(id)</span>
<span class="nc" id="L278">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Annonce&quot;, &quot;id&quot;, id));</span>

        // Rechercher des annonces similaires par catégorie et proximité géographique
<span class="nc" id="L281">        List&lt;Listing&gt; similarListings = listingRepository.findSimilarListings(</span>
            id, 
<span class="nc" id="L283">            referenceListing.getCategory(),</span>
<span class="nc" id="L284">            referenceListing.getLatitude(),</span>
<span class="nc" id="L285">            referenceListing.getLongitude(),</span>
            limit
        );

<span class="nc" id="L289">        return similarListings.stream()</span>
<span class="nc" id="L290">            .map(modelMapper::mapListingToListingResponse)</span>
<span class="nc" id="L291">            .collect(Collectors.toList());</span>
    }

    /**
     * Incrémenter le compteur de vues
     */
    @Transactional
    public void incrementViewCount(String id) {
<span class="nc" id="L299">        Listing listing = listingRepository.findById(id)</span>
<span class="nc" id="L300">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Annonce&quot;, &quot;id&quot;, id));</span>

<span class="nc" id="L302">        listing.incrementViewCount();</span>
<span class="nc" id="L303">        listingRepository.save(listing);</span>
<span class="nc" id="L304">    }</span>

    /**
     * Obtenir les statistiques des annonces
     */
    @Transactional(readOnly = true)
    public long getTotalActiveListings() {
<span class="nc" id="L311">        return listingRepository.countByStatusAndIsModerated(</span>
<span class="nc" id="L312">            Listing.ListingStatus.ACTIVE, true);</span>
    }

    @Transactional(readOnly = true)
    public long getTodayListings() {
<span class="nc" id="L317">        LocalDateTime startOfDay = LocalDateTime.now().toLocalDate().atStartOfDay();</span>
<span class="nc" id="L318">        LocalDateTime endOfDay = startOfDay.plusDays(1).minusNanos(1);</span>
        
<span class="nc" id="L320">        return listingRepository.countByCreatedAtBetween(startOfDay, endOfDay);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>