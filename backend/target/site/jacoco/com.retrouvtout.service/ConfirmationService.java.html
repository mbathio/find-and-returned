<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConfirmationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RetrouvTout Backend</a> &gt; <a href="index.source.html" class="el_package">com.retrouvtout.service</a> &gt; <span class="el_source">ConfirmationService.java</span></div><h1>ConfirmationService.java</h1><pre class="source lang-java linenums">package com.retrouvtout.service;

import com.retrouvtout.dto.response.ConfirmationResponse;
import com.retrouvtout.entity.Confirmation;
import com.retrouvtout.entity.Thread;
import com.retrouvtout.entity.User;
import com.retrouvtout.exception.ResourceNotFoundException;
import com.retrouvtout.repository.ConfirmationRepository;
import com.retrouvtout.repository.ThreadRepository;
import com.retrouvtout.repository.UserRepository;
import com.retrouvtout.util.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.security.SecureRandom;
import java.time.LocalDateTime;
import java.util.List;

/**
 * Service pour la gestion des confirmations de remise d'objets
 */
@Service
@Transactional
public class ConfirmationService {

    private final ConfirmationRepository confirmationRepository;
    private final ThreadRepository threadRepository;
    private final UserRepository userRepository;
    private final ModelMapper modelMapper;
    private final SmsService smsService;
    private final EmailService emailService;
    private final NotificationService notificationService;

    private static final String CHARACTERS = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;;
    private static final int CODE_LENGTH = 6;
    private static final int EXPIRATION_HOURS = 24;

    @Autowired
    public ConfirmationService(ConfirmationRepository confirmationRepository,
                              ThreadRepository threadRepository,
                              UserRepository userRepository,
                              ModelMapper modelMapper,
                              SmsService smsService,
                              EmailService emailService,
<span class="nc" id="L47">                              NotificationService notificationService) {</span>
<span class="nc" id="L48">        this.confirmationRepository = confirmationRepository;</span>
<span class="nc" id="L49">        this.threadRepository = threadRepository;</span>
<span class="nc" id="L50">        this.userRepository = userRepository;</span>
<span class="nc" id="L51">        this.modelMapper = modelMapper;</span>
<span class="nc" id="L52">        this.smsService = smsService;</span>
<span class="nc" id="L53">        this.emailService = emailService;</span>
<span class="nc" id="L54">        this.notificationService = notificationService;</span>
<span class="nc" id="L55">    }</span>

    /**
     * Générer un code de confirmation pour un thread
     */
    public ConfirmationResponse generateConfirmation(String threadId, String userId) {
<span class="nc" id="L61">        User user = userRepository.findByIdAndActiveTrue(userId)</span>
<span class="nc" id="L62">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Utilisateur&quot;, &quot;id&quot;, userId));</span>

<span class="nc" id="L64">        Thread thread = threadRepository.findById(threadId)</span>
<span class="nc" id="L65">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Thread&quot;, &quot;id&quot;, threadId));</span>

        // Vérifier que l'utilisateur fait partie du thread
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (!thread.getOwnerUser().getId().equals(userId) &amp;&amp; </span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">            !thread.getFinderUser().getId().equals(userId)) {</span>
<span class="nc" id="L70">            throw new SecurityException(&quot;Vous n'êtes pas autorisé à générer un code pour ce thread&quot;);</span>
        }

        // Vérifier que le thread est approuvé
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (thread.getStatus() != Thread.ThreadStatus.APPROVED) {</span>
<span class="nc" id="L75">            throw new IllegalArgumentException(&quot;Le thread doit être approuvé pour générer un code de confirmation&quot;);</span>
        }

        // Supprimer l'ancienne confirmation si elle existe
<span class="nc" id="L79">        confirmationRepository.findByThread(thread)</span>
<span class="nc" id="L80">            .ifPresent(confirmationRepository::delete);</span>

        // Générer un nouveau code
<span class="nc" id="L83">        String code = generateRandomCode();</span>
<span class="nc" id="L84">        LocalDateTime expiresAt = LocalDateTime.now().plusHours(EXPIRATION_HOURS);</span>

<span class="nc" id="L86">        Confirmation confirmation = new Confirmation();</span>
<span class="nc" id="L87">        confirmation.setId(java.util.UUID.randomUUID().toString());</span>
<span class="nc" id="L88">        confirmation.setThread(thread);</span>
<span class="nc" id="L89">        confirmation.setCode(code);</span>
<span class="nc" id="L90">        confirmation.setExpiresAt(expiresAt);</span>

<span class="nc" id="L92">        Confirmation savedConfirmation = confirmationRepository.save(confirmation);</span>

        // Envoyer le code aux deux parties
<span class="nc" id="L95">        sendConfirmationCode(thread, code);</span>

<span class="nc" id="L97">        return modelMapper.mapConfirmationToConfirmationResponse(savedConfirmation);</span>
    }

    /**
     * Valider un code de confirmation
     */
    public ConfirmationResponse validateConfirmation(String code, String userId) {
<span class="nc" id="L104">        User user = userRepository.findByIdAndActiveTrue(userId)</span>
<span class="nc" id="L105">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Utilisateur&quot;, &quot;id&quot;, userId));</span>

<span class="nc" id="L107">        Confirmation confirmation = confirmationRepository.findByCode(code)</span>
<span class="nc" id="L108">            .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Code de confirmation invalide&quot;));</span>

        // Vérifier que le code n'est pas expiré
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (confirmation.isExpired()) {</span>
<span class="nc" id="L112">            throw new IllegalArgumentException(&quot;Code de confirmation expiré&quot;);</span>
        }

        // Vérifier que le code n'est pas déjà utilisé
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (confirmation.isUsed()) {</span>
<span class="nc" id="L117">            throw new IllegalArgumentException(&quot;Code de confirmation déjà utilisé&quot;);</span>
        }

<span class="nc" id="L120">        Thread thread = confirmation.getThread();</span>

        // Vérifier que l'utilisateur fait partie du thread
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (!thread.getOwnerUser().getId().equals(userId) &amp;&amp; </span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">            !thread.getFinderUser().getId().equals(userId)) {</span>
<span class="nc" id="L125">            throw new SecurityException(&quot;Vous n'êtes pas autorisé à utiliser ce code&quot;);</span>
        }

        // Marquer le code comme utilisé
<span class="nc" id="L129">        confirmation.setUsedAt(LocalDateTime.now());</span>
<span class="nc" id="L130">        confirmation.setUsedByUser(user);</span>

        // Marquer le thread comme fermé
<span class="nc" id="L133">        thread.setStatus(Thread.ThreadStatus.CLOSED);</span>

        // Marquer l'annonce comme résolue
<span class="nc" id="L136">        thread.getListing().setStatus(com.retrouvtout.entity.Listing.ListingStatus.RESOLU);</span>

<span class="nc" id="L138">        confirmationRepository.save(confirmation);</span>
<span class="nc" id="L139">        threadRepository.save(thread);</span>

        // Notifier les parties de la remise réussie
<span class="nc" id="L142">        notifySuccessfulHandover(thread, user);</span>

<span class="nc" id="L144">        return modelMapper.mapConfirmationToConfirmationResponse(confirmation);</span>
    }

    /**
     * Obtenir la confirmation d'un thread
     */
    @Transactional(readOnly = true)
    public ConfirmationResponse getThreadConfirmation(String threadId, String userId) {
<span class="nc" id="L152">        Thread thread = threadRepository.findById(threadId)</span>
<span class="nc" id="L153">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Thread&quot;, &quot;id&quot;, threadId));</span>

        // Vérifier l'accès
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (!thread.getOwnerUser().getId().equals(userId) &amp;&amp; </span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            !thread.getFinderUser().getId().equals(userId)) {</span>
<span class="nc" id="L158">            throw new SecurityException(&quot;Vous n'êtes pas autorisé à accéder à cette confirmation&quot;);</span>
        }

<span class="nc" id="L161">        Confirmation confirmation = confirmationRepository.findByThread(thread)</span>
<span class="nc" id="L162">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Confirmation&quot;, &quot;threadId&quot;, threadId));</span>

<span class="nc" id="L164">        return modelMapper.mapConfirmationToConfirmationResponse(confirmation);</span>
    }

    /**
     * Générer un code aléatoire
     */
    private String generateRandomCode() {
<span class="nc" id="L171">        SecureRandom random = new SecureRandom();</span>
<span class="nc" id="L172">        StringBuilder code = new StringBuilder(CODE_LENGTH);</span>
        
<span class="nc bnc" id="L174" title="All 2 branches missed.">        for (int i = 0; i &lt; CODE_LENGTH; i++) {</span>
<span class="nc" id="L175">            code.append(CHARACTERS.charAt(random.nextInt(CHARACTERS.length())));</span>
        }
        
<span class="nc" id="L178">        return code.toString();</span>
    }

    /**
     * Envoyer le code de confirmation aux parties
     */
    private void sendConfirmationCode(Thread thread, String code) {
        try {
<span class="nc" id="L186">            String listingTitle = thread.getListing().getTitle();</span>
<span class="nc" id="L187">            String message = String.format(</span>
                &quot;Retrouv'Tout: Code de remise pour '%s': %s. Valable 24h.&quot;,
                listingTitle, code
            );

            // Envoyer par SMS si les numéros sont disponibles
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (thread.getOwnerUser().getPhone() != null) {</span>
<span class="nc" id="L194">                smsService.sendSms(thread.getOwnerUser().getPhone(), message);</span>
            }

<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (thread.getFinderUser().getPhone() != null) {</span>
<span class="nc" id="L198">                smsService.sendSms(thread.getFinderUser().getPhone(), message);</span>
            }

            // Envoyer par notification push
<span class="nc" id="L202">            String title = &quot;Code de remise généré&quot;;</span>
<span class="nc" id="L203">            String body = String.format(&quot;Code: %s (valable 24h)&quot;, code);</span>
<span class="nc" id="L204">            String url = &quot;/messages/&quot; + thread.getId();</span>

<span class="nc" id="L206">            notificationService.sendPushNotification(</span>
<span class="nc" id="L207">                thread.getOwnerUser().getId(), title, body, url);</span>
<span class="nc" id="L208">            notificationService.sendPushNotification(</span>
<span class="nc" id="L209">                thread.getFinderUser().getId(), title, body, url);</span>

<span class="nc" id="L211">        } catch (Exception e) {</span>
<span class="nc" id="L212">            System.err.println(&quot;Erreur lors de l'envoi du code de confirmation: &quot; + e.getMessage());</span>
<span class="nc" id="L213">        }</span>
<span class="nc" id="L214">    }</span>

    /**
     * Notifier les parties de la remise réussie
     */
    private void notifySuccessfulHandover(Thread thread, User validator) {
        try {
<span class="nc" id="L221">            String listingTitle = thread.getListing().getTitle();</span>
            
            // Notifier les deux parties
<span class="nc" id="L224">            String ownerTitle = &quot;Objet récupéré avec succès !&quot;;</span>
<span class="nc" id="L225">            String ownerBody = String.format(&quot;Vous avez récupéré: %s&quot;, listingTitle);</span>
            
<span class="nc" id="L227">            String finderTitle = &quot;Remise confirmée !&quot;;</span>
<span class="nc" id="L228">            String finderBody = String.format(&quot;Objet remis avec succès: %s&quot;, listingTitle);</span>

<span class="nc" id="L230">            notificationService.sendPushNotification(</span>
<span class="nc" id="L231">                thread.getOwnerUser().getId(), ownerTitle, ownerBody, &quot;/profil&quot;);</span>
<span class="nc" id="L232">            notificationService.sendPushNotification(</span>
<span class="nc" id="L233">                thread.getFinderUser().getId(), finderTitle, finderBody, &quot;/profil&quot;);</span>

            // Envoyer par SMS de confirmation
<span class="nc" id="L236">            String ownerSms = String.format(</span>
                &quot;Retrouv'Tout: Remise confirmée pour '%s'. Merci d'avoir utilisé notre service !&quot;,
                listingTitle
            );
<span class="nc" id="L240">            String finderSms = String.format(</span>
                &quot;Retrouv'Tout: Merci d'avoir aidé à retrouver '%s'. Votre geste compte !&quot;,
                listingTitle
            );

<span class="nc bnc" id="L245" title="All 2 branches missed.">            if (thread.getOwnerUser().getPhone() != null) {</span>
<span class="nc" id="L246">                smsService.sendSms(thread.getOwnerUser().getPhone(), ownerSms);</span>
            }

<span class="nc bnc" id="L249" title="All 2 branches missed.">            if (thread.getFinderUser().getPhone() != null) {</span>
<span class="nc" id="L250">                smsService.sendSms(thread.getFinderUser().getPhone(), finderSms);</span>
            }

<span class="nc" id="L253">        } catch (Exception e) {</span>
<span class="nc" id="L254">            System.err.println(&quot;Erreur lors de l'envoi des notifications de remise: &quot; + e.getMessage());</span>
<span class="nc" id="L255">        }</span>
<span class="nc" id="L256">    }</span>

    /**
     * Nettoyer les confirmations expirées (tâche planifiée)
     */
    @Scheduled(fixedRate = 3600000) // Toutes les heures
    public void cleanupExpiredConfirmations() {
        try {
<span class="nc" id="L264">            LocalDateTime now = LocalDateTime.now();</span>
<span class="nc" id="L265">            List&lt;Confirmation&gt; expiredConfirmations = confirmationRepository.findExpiredConfirmations(now);</span>
            
<span class="nc bnc" id="L267" title="All 2 branches missed.">            for (Confirmation confirmation : expiredConfirmations) {</span>
<span class="nc" id="L268">                confirmationRepository.delete(confirmation);</span>
<span class="nc" id="L269">            }</span>
            
<span class="nc bnc" id="L271" title="All 2 branches missed.">            if (!expiredConfirmations.isEmpty()) {</span>
<span class="nc" id="L272">                System.out.println(&quot;Nettoyé &quot; + expiredConfirmations.size() + &quot; confirmations expirées&quot;);</span>
            }
<span class="nc" id="L274">        } catch (Exception e) {</span>
<span class="nc" id="L275">            System.err.println(&quot;Erreur lors du nettoyage des confirmations expirées: &quot; + e.getMessage());</span>
<span class="nc" id="L276">        }</span>
<span class="nc" id="L277">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>