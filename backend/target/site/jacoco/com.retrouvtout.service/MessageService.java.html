<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessageService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RetrouvTout Backend</a> &gt; <a href="index.source.html" class="el_package">com.retrouvtout.service</a> &gt; <span class="el_source">MessageService.java</span></div><h1>MessageService.java</h1><pre class="source lang-java linenums">package com.retrouvtout.service;

import com.retrouvtout.dto.request.CreateMessageRequest;
import com.retrouvtout.dto.response.MessageResponse;
import com.retrouvtout.entity.Message;
import com.retrouvtout.entity.Thread;
import com.retrouvtout.entity.User;
import com.retrouvtout.exception.ResourceNotFoundException;
import com.retrouvtout.repository.MessageRepository;
import com.retrouvtout.repository.ThreadRepository;
import com.retrouvtout.repository.UserRepository;
import com.retrouvtout.util.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;

/**
 * Service pour la gestion des messages
 */
@Service
@Transactional
public class MessageService {

    private final MessageRepository messageRepository;
    private final ThreadRepository threadRepository;
    private final UserRepository userRepository;
    private final ModelMapper modelMapper;
    private final SimpMessagingTemplate messagingTemplate;
    private final EmailService emailService;
    private final NotificationService notificationService;

    @Autowired
    public MessageService(MessageRepository messageRepository,
                         ThreadRepository threadRepository,
                         UserRepository userRepository,
                         ModelMapper modelMapper,
                         SimpMessagingTemplate messagingTemplate,
                         EmailService emailService,
<span class="nc" id="L44">                         NotificationService notificationService) {</span>
<span class="nc" id="L45">        this.messageRepository = messageRepository;</span>
<span class="nc" id="L46">        this.threadRepository = threadRepository;</span>
<span class="nc" id="L47">        this.userRepository = userRepository;</span>
<span class="nc" id="L48">        this.modelMapper = modelMapper;</span>
<span class="nc" id="L49">        this.messagingTemplate = messagingTemplate;</span>
<span class="nc" id="L50">        this.emailService = emailService;</span>
<span class="nc" id="L51">        this.notificationService = notificationService;</span>
<span class="nc" id="L52">    }</span>

    /**
     * Créer un nouveau message
     */
    public MessageResponse createMessage(CreateMessageRequest request, String userId) {
<span class="nc" id="L58">        User sender = userRepository.findByIdAndActiveTrue(userId)</span>
<span class="nc" id="L59">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Utilisateur&quot;, &quot;id&quot;, userId));</span>

<span class="nc" id="L61">        Thread thread = threadRepository.findById(request.getThreadId())</span>
<span class="nc" id="L62">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Thread&quot;, &quot;id&quot;, request.getThreadId()));</span>

        // Vérifier que l'utilisateur fait partie du thread
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (!thread.getOwnerUser().getId().equals(userId) &amp;&amp; </span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">            !thread.getFinderUser().getId().equals(userId)) {</span>
<span class="nc" id="L67">            throw new SecurityException(&quot;Vous n'êtes pas autorisé à envoyer un message dans ce thread&quot;);</span>
        }

        // Créer le message
<span class="nc" id="L71">        Message message = new Message();</span>
<span class="nc" id="L72">        message.setId(java.util.UUID.randomUUID().toString());</span>
<span class="nc" id="L73">        message.setThread(thread);</span>
<span class="nc" id="L74">        message.setSenderUser(sender);</span>
<span class="nc" id="L75">        message.setBody(request.getBody());</span>
<span class="nc" id="L76">        message.setMessageType(Message.MessageType.fromValue(request.getMessageType()));</span>
<span class="nc" id="L77">        message.setIsRead(false);</span>

<span class="nc" id="L79">        Message savedMessage = messageRepository.save(message);</span>

        // Mettre à jour la date du dernier message du thread
<span class="nc" id="L82">        thread.setLastMessageAt(LocalDateTime.now());</span>
<span class="nc" id="L83">        threadRepository.save(thread);</span>

        // Convertir en DTO
<span class="nc" id="L86">        MessageResponse messageResponse = modelMapper.mapMessageToMessageResponse(savedMessage);</span>

        // Envoyer notification en temps réel via WebSocket
<span class="nc" id="L89">        sendRealtimeNotification(thread, messageResponse, userId);</span>

        // Envoyer notification email au destinataire
<span class="nc" id="L92">        sendEmailNotification(thread, sender, userId);</span>

        // Envoyer notification push
<span class="nc" id="L95">        sendPushNotification(thread, savedMessage, userId);</span>

<span class="nc" id="L97">        return messageResponse;</span>
    }

    /**
     * Obtenir les messages d'un thread
     */
    @Transactional(readOnly = true)
    public Page&lt;MessageResponse&gt; getThreadMessages(String threadId, String userId, Pageable pageable) {
<span class="nc" id="L105">        Thread thread = threadRepository.findById(threadId)</span>
<span class="nc" id="L106">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Thread&quot;, &quot;id&quot;, threadId));</span>

        // Vérifier l'accès
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (!thread.getOwnerUser().getId().equals(userId) &amp;&amp; </span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">            !thread.getFinderUser().getId().equals(userId)) {</span>
<span class="nc" id="L111">            throw new SecurityException(&quot;Vous n'êtes pas autorisé à accéder à ce thread&quot;);</span>
        }

<span class="nc" id="L114">        Page&lt;Message&gt; messages = messageRepository.findByThreadOrderByCreatedAtAsc(thread, pageable);</span>
<span class="nc" id="L115">        return messages.map(modelMapper::mapMessageToMessageResponse);</span>
    }

    /**
     * Marquer tous les messages d'un thread comme lus
     */
    public void markThreadAsRead(String threadId, String userId) {
<span class="nc" id="L122">        Thread thread = threadRepository.findById(threadId)</span>
<span class="nc" id="L123">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Thread&quot;, &quot;id&quot;, threadId));</span>

        // Vérifier l'accès
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (!thread.getOwnerUser().getId().equals(userId) &amp;&amp; </span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">            !thread.getFinderUser().getId().equals(userId)) {</span>
<span class="nc" id="L128">            throw new SecurityException(&quot;Vous n'êtes pas autorisé à accéder à ce thread&quot;);</span>
        }

<span class="nc" id="L131">        User user = userRepository.findByIdAndActiveTrue(userId)</span>
<span class="nc" id="L132">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Utilisateur&quot;, &quot;id&quot;, userId));</span>

        // Marquer tous les messages non lus comme lus
<span class="nc" id="L135">        messageRepository.markAllAsReadInThreadForUser(thread, user);</span>
<span class="nc" id="L136">    }</span>

    /**
     * Obtenir le nombre de messages non lus pour un utilisateur
     */
    @Transactional(readOnly = true)
    public long getUnreadMessageCount(String userId) {
<span class="nc" id="L143">        User user = userRepository.findByIdAndActiveTrue(userId)</span>
<span class="nc" id="L144">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Utilisateur&quot;, &quot;id&quot;, userId));</span>

<span class="nc" id="L146">        return threadRepository.countUnreadThreadsForUser(user);</span>
    }

    /**
     * Envoyer une notification en temps réel via WebSocket
     */
    private void sendRealtimeNotification(Thread thread, MessageResponse message, String senderId) {
        // Déterminer le destinataire
<span class="nc bnc" id="L154" title="All 2 branches missed.">        String recipientId = thread.getOwnerUser().getId().equals(senderId) ?</span>
<span class="nc" id="L155">            thread.getFinderUser().getId() : thread.getOwnerUser().getId();</span>

        // Envoyer via WebSocket
<span class="nc" id="L158">        messagingTemplate.convertAndSendToUser(</span>
            recipientId,
            &quot;/queue/messages&quot;,
            message
        );

        // Envoyer notification de nouveau message
<span class="nc" id="L165">        messagingTemplate.convertAndSendToUser(</span>
            recipientId,
            &quot;/queue/notifications&quot;,
            new NotificationMessage(&quot;new_message&quot;, &quot;Nouveau message reçu&quot;, message)
        );
<span class="nc" id="L170">    }</span>

    /**
     * Envoyer notification email
     */
    private void sendEmailNotification(Thread thread, User sender, String senderId) {
        try {
            // Déterminer le destinataire
<span class="nc bnc" id="L178" title="All 2 branches missed.">            User recipient = thread.getOwnerUser().getId().equals(senderId) ?</span>
<span class="nc" id="L179">                thread.getFinderUser() : thread.getOwnerUser();</span>

<span class="nc bnc" id="L181" title="All 2 branches missed.">            if (recipient.getEmailVerified()) {</span>
<span class="nc" id="L182">                String threadSubject = thread.getListing().getTitle();</span>
<span class="nc" id="L183">                emailService.sendNewMessageNotification(recipient, sender, threadSubject);</span>
            }
<span class="nc" id="L185">        } catch (Exception e) {</span>
<span class="nc" id="L186">            System.err.println(&quot;Erreur lors de l'envoi de la notification email: &quot; + e.getMessage());</span>
<span class="nc" id="L187">        }</span>
<span class="nc" id="L188">    }</span>

    /**
     * Envoyer notification push
     */
    private void sendPushNotification(Thread thread, Message message, String senderId) {
        try {
            // Déterminer le destinataire
<span class="nc bnc" id="L196" title="All 2 branches missed.">            String recipientId = thread.getOwnerUser().getId().equals(senderId) ?</span>
<span class="nc" id="L197">                thread.getFinderUser().getId() : thread.getOwnerUser().getId();</span>

<span class="nc" id="L199">            String title = &quot;Nouveau message&quot;;</span>
<span class="nc" id="L200">            String body = String.format(&quot;Message concernant: %s&quot;, thread.getListing().getTitle());</span>
<span class="nc" id="L201">            String url = &quot;/messages/&quot; + thread.getId();</span>

<span class="nc" id="L203">            notificationService.sendPushNotification(recipientId, title, body, url);</span>
<span class="nc" id="L204">        } catch (Exception e) {</span>
<span class="nc" id="L205">            System.err.println(&quot;Erreur lors de l'envoi de la notification push: &quot; + e.getMessage());</span>
<span class="nc" id="L206">        }</span>
<span class="nc" id="L207">    }</span>

    /**
     * Classe pour les notifications WebSocket
     */
    public static class NotificationMessage {
        private String type;
        private String title;
        private Object data;

<span class="nc" id="L217">        public NotificationMessage(String type, String title, Object data) {</span>
<span class="nc" id="L218">            this.type = type;</span>
<span class="nc" id="L219">            this.title = title;</span>
<span class="nc" id="L220">            this.data = data;</span>
<span class="nc" id="L221">        }</span>

        // Getters et setters
<span class="nc" id="L224">        public String getType() { return type; }</span>
<span class="nc" id="L225">        public void setType(String type) { this.type = type; }</span>

<span class="nc" id="L227">        public String getTitle() { return title; }</span>
<span class="nc" id="L228">        public void setTitle(String title) { this.title = title; }</span>

<span class="nc" id="L230">        public Object getData() { return data; }</span>
<span class="nc" id="L231">        public void setData(Object data) { this.data = data; }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>