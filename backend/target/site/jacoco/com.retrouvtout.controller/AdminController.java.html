<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdminController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RetrouvTout Backend</a> &gt; <a href="index.source.html" class="el_package">com.retrouvtout.controller</a> &gt; <span class="el_source">AdminController.java</span></div><h1>AdminController.java</h1><pre class="source lang-java linenums">package com.retrouvtout.controller;

import com.retrouvtout.dto.response.ApiResponse;
import com.retrouvtout.dto.response.PagedResponse;
import com.retrouvtout.dto.response.UserResponse;
import com.retrouvtout.dto.response.ListingResponse;
import com.retrouvtout.security.UserPrincipal;
import com.retrouvtout.service.UserService;
import com.retrouvtout.service.ListingService;
import com.retrouvtout.service.AlertService;
import com.retrouvtout.service.ThreadService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import com.retrouvtout.dto.response.ApiResponse;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;

/**
 * Contrôleur d'administration pour la gestion du système
 */
@RestController
@RequestMapping(&quot;/admin&quot;)
@Tag(name = &quot;Administration&quot;, description = &quot;API d'administration du système&quot;)
@CrossOrigin(origins = {&quot;${app.cors.allowed-origins}&quot;})
@PreAuthorize(&quot;hasRole('ADMIN')&quot;)
public class AdminController {

    private final UserService userService;
    private final ListingService listingService;
    private final AlertService alertService;
    private final ThreadService threadService;

    @Autowired
    public AdminController(UserService userService,
                          ListingService listingService,
                          AlertService alertService,
<span class="nc" id="L52">                          ThreadService threadService) {</span>
<span class="nc" id="L53">        this.userService = userService;</span>
<span class="nc" id="L54">        this.listingService = listingService;</span>
<span class="nc" id="L55">        this.alertService = alertService;</span>
<span class="nc" id="L56">        this.threadService = threadService;</span>
<span class="nc" id="L57">    }</span>

    /**
     * Tableau de bord administrateur
     */
    @GetMapping(&quot;/dashboard&quot;)
    @Operation(summary = &quot;Obtenir les statistiques du tableau de bord&quot;)
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    @ApiResponses(value = {
    @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description = &quot;...&quot;)
})
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; getDashboard() {
<span class="nc" id="L69">        Map&lt;String, Object&gt; stats = new HashMap&lt;&gt;();</span>

        // Statistiques utilisateurs
<span class="nc" id="L72">        stats.put(&quot;totalUsers&quot;, userService.getTotalActiveUsers());</span>
<span class="nc" id="L73">        stats.put(&quot;newUsersToday&quot;, getUsersToday());</span>

        // Statistiques annonces
<span class="nc" id="L76">        stats.put(&quot;totalListings&quot;, listingService.getTotalActiveListings());</span>
<span class="nc" id="L77">        stats.put(&quot;newListingsToday&quot;, listingService.getTodayListings());</span>

        // Statistiques système
<span class="nc" id="L80">        stats.put(&quot;systemHealth&quot;, getSystemHealth());</span>
<span class="nc" id="L81">        stats.put(&quot;lastUpdate&quot;, LocalDateTime.now());</span>

<span class="nc" id="L83">        return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
            true,
            &quot;Statistiques du tableau de bord récupérées&quot;,
            stats
        ));
    }

    /**
     * Gestion des utilisateurs
     */
    @GetMapping(&quot;/users&quot;)
    @Operation(summary = &quot;Obtenir la liste des utilisateurs&quot;)
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    public ResponseEntity&lt;ApiResponse&lt;PagedResponse&lt;UserResponse&gt;&gt;&gt; getUsers(
            @Parameter(description = &quot;Numéro de page&quot;)
            @RequestParam(defaultValue = &quot;1&quot;) int page,
            
            @Parameter(description = &quot;Taille de la page&quot;)
            @RequestParam(defaultValue = &quot;20&quot;) int pageSize,
            
            @Parameter(description = &quot;Recherche par nom ou email&quot;)
            @RequestParam(required = false) String search) {

<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (page &lt; 1) page = 1;</span>
<span class="nc bnc" id="L107" title="All 4 branches missed.">        if (pageSize &lt; 1 || pageSize &gt; 100) pageSize = 20;</span>

<span class="nc" id="L109">        Pageable pageable = PageRequest.of(page - 1, pageSize, </span>
<span class="nc" id="L110">            Sort.by(Sort.Direction.DESC, &quot;createdAt&quot;));</span>

        Page&lt;UserResponse&gt; users;
<span class="nc bnc" id="L113" title="All 4 branches missed.">        if (search != null &amp;&amp; !search.trim().isEmpty()) {</span>
<span class="nc" id="L114">            users = userService.searchUsers(search.trim(), pageable);</span>
        } else {
<span class="nc" id="L116">            users = userService.getAllUsers(pageable);</span>
        }

<span class="nc" id="L119">        PagedResponse&lt;UserResponse&gt; pagedResponse = new PagedResponse&lt;&gt;(</span>
<span class="nc" id="L120">            users.getContent(),</span>
<span class="nc" id="L121">            users.getNumber() + 1,</span>
<span class="nc" id="L122">            users.getSize(),</span>
<span class="nc" id="L123">            users.getTotalElements(),</span>
<span class="nc" id="L124">            users.getTotalPages(),</span>
<span class="nc" id="L125">            users.isLast()</span>
        );

<span class="nc" id="L128">        return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
            true,
            &quot;Liste des utilisateurs récupérée&quot;,
            pagedResponse
        ));
    }

    /**
     * Désactiver un utilisateur
     */
    @PatchMapping(&quot;/users/{id}/deactivate&quot;)
    @Operation(summary = &quot;Désactiver un utilisateur&quot;)
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; deactivateUser(
            @Parameter(description = &quot;ID de l'utilisateur&quot;)
            @PathVariable String id,
            @AuthenticationPrincipal UserPrincipal userPrincipal) {

        // Empêcher l'auto-désactivation
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (id.equals(userPrincipal.getId())) {</span>
<span class="nc" id="L148">            return ResponseEntity.badRequest()</span>
<span class="nc" id="L149">                .body(new ApiResponse&lt;&gt;(</span>
                    false,
                    &quot;Vous ne pouvez pas vous désactiver vous-même&quot;,
                    null
                ));
        }

        try {
<span class="nc" id="L157">            userService.deactivateUser(id);</span>
            
<span class="nc" id="L159">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Utilisateur désactivé avec succès&quot;,
                null
            ));
<span class="nc" id="L164">        } catch (Exception e) {</span>
<span class="nc" id="L165">            return ResponseEntity.notFound().build();</span>
        }
    }

    /**
     * Réactiver un utilisateur
     */
    @PatchMapping(&quot;/users/{id}/reactivate&quot;)
    @Operation(summary = &quot;Réactiver un utilisateur&quot;)
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; reactivateUser(
            @Parameter(description = &quot;ID de l'utilisateur&quot;)
            @PathVariable String id) {

        try {
<span class="nc" id="L180">            userService.reactivateUser(id);</span>
            
<span class="nc" id="L182">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Utilisateur réactivé avec succès&quot;,
                null
            ));
<span class="nc" id="L187">        } catch (Exception e) {</span>
<span class="nc" id="L188">            return ResponseEntity.notFound().build();</span>
        }
    }

    /**
     * Statistiques détaillées du système
     */
    @GetMapping(&quot;/stats&quot;)
    @Operation(summary = &quot;Obtenir les statistiques détaillées&quot;)
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; getDetailedStats() {
<span class="nc" id="L199">        Map&lt;String, Object&gt; stats = new HashMap&lt;&gt;();</span>

        // Statistiques par période
<span class="nc" id="L202">        stats.put(&quot;userGrowth&quot;, getUserGrowthStats());</span>
<span class="nc" id="L203">        stats.put(&quot;listingGrowth&quot;, getListingGrowthStats());</span>
<span class="nc" id="L204">        stats.put(&quot;activityStats&quot;, getActivityStats());</span>

<span class="nc" id="L206">        return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
            true,
            &quot;Statistiques détaillées récupérées&quot;,
            stats
        ));
    }

    /**
     * Logs du système
     */
    @GetMapping(&quot;/logs&quot;)
    @Operation(summary = &quot;Obtenir les logs du système&quot;)
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    public ResponseEntity&lt;ApiResponse&lt;PagedResponse&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; getLogs(
            @Parameter(description = &quot;Numéro de page&quot;)
            @RequestParam(defaultValue = &quot;1&quot;) int page,
            
            @Parameter(description = &quot;Taille de la page&quot;)
            @RequestParam(defaultValue = &quot;50&quot;) int pageSize,
            
            @Parameter(description = &quot;Niveau de log&quot;)
            @RequestParam(required = false) String level) {

        // Implémentation simplifiée - en production, connecter à un système de logs
<span class="nc" id="L230">        Map&lt;String, Object&gt; logEntry = new HashMap&lt;&gt;();</span>
<span class="nc" id="L231">        logEntry.put(&quot;timestamp&quot;, LocalDateTime.now());</span>
<span class="nc" id="L232">        logEntry.put(&quot;level&quot;, &quot;INFO&quot;);</span>
<span class="nc" id="L233">        logEntry.put(&quot;message&quot;, &quot;Système fonctionnel&quot;);</span>
<span class="nc" id="L234">        logEntry.put(&quot;source&quot;, &quot;AdminController&quot;);</span>

<span class="nc" id="L236">        PagedResponse&lt;Map&lt;String, Object&gt;&gt; response = new PagedResponse&lt;&gt;();</span>
<span class="nc" id="L237">        response.setItems(java.util.List.of(logEntry));</span>
<span class="nc" id="L238">        response.setPage(page);</span>
<span class="nc" id="L239">        response.setPageSize(pageSize);</span>
<span class="nc" id="L240">        response.setTotalElements(1);</span>
<span class="nc" id="L241">        response.setTotalPages(1);</span>
<span class="nc" id="L242">        response.setLast(true);</span>

<span class="nc" id="L244">        return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
            true,
            &quot;Logs récupérés&quot;,
            response
        ));
    }

    /**
     * Configuration du système
     */
    @GetMapping(&quot;/config&quot;)
    @Operation(summary = &quot;Obtenir la configuration du système&quot;)
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; getSystemConfig() {
<span class="nc" id="L258">        Map&lt;String, Object&gt; config = new HashMap&lt;&gt;();</span>
        
<span class="nc" id="L260">        config.put(&quot;version&quot;, &quot;1.0.0&quot;);</span>
<span class="nc" id="L261">        config.put(&quot;environment&quot;, &quot;production&quot;);</span>
<span class="nc" id="L262">        config.put(&quot;features&quot;, Map.of(</span>
<span class="nc" id="L263">            &quot;emailNotifications&quot;, true,</span>
<span class="nc" id="L264">            &quot;smsNotifications&quot;, false,</span>
<span class="nc" id="L265">            &quot;autoModeration&quot;, true,</span>
<span class="nc" id="L266">            &quot;geocoding&quot;, true</span>
        ));
<span class="nc" id="L268">        config.put(&quot;limits&quot;, Map.of(</span>
            &quot;maxFileSize&quot;, &quot;10MB&quot;,
<span class="nc" id="L270">            &quot;maxListingsPerDay&quot;, 10,</span>
<span class="nc" id="L271">            &quot;maxAlertsPerUser&quot;, 20</span>
        ));

<span class="nc" id="L274">        return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
            true,
            &quot;Configuration système récupérée&quot;,
            config
        ));
    }

    /**
     * Mise à jour de configuration
     */
    @PutMapping(&quot;/config&quot;)
    @Operation(summary = &quot;Mettre à jour la configuration&quot;)
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; updateConfig(
            @RequestBody Map&lt;String, Object&gt; configUpdates) {
        
        // Implémentation simplifiée - en production, sauvegarder en base
<span class="nc" id="L291">        return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
            true,
            &quot;Configuration mise à jour avec succès&quot;,
            null
        ));
    }

    // Méthodes utilitaires privées

    private long getUsersToday() {
        // Implémentation simplifiée
<span class="nc" id="L302">        return 5L;</span>
    }

    private Map&lt;String, Object&gt; getSystemHealth() {
<span class="nc" id="L306">        Map&lt;String, Object&gt; health = new HashMap&lt;&gt;();</span>
<span class="nc" id="L307">        health.put(&quot;status&quot;, &quot;UP&quot;);</span>
<span class="nc" id="L308">        health.put(&quot;database&quot;, &quot;UP&quot;);</span>
<span class="nc" id="L309">        health.put(&quot;redis&quot;, &quot;UP&quot;);</span>
<span class="nc" id="L310">        health.put(&quot;email&quot;, &quot;UP&quot;);</span>
<span class="nc" id="L311">        return health;</span>
    }

    private Map&lt;String, Object&gt; getUserGrowthStats() {
<span class="nc" id="L315">        Map&lt;String, Object&gt; growth = new HashMap&lt;&gt;();</span>
<span class="nc" id="L316">        growth.put(&quot;thisMonth&quot;, 150);</span>
<span class="nc" id="L317">        growth.put(&quot;lastMonth&quot;, 120);</span>
<span class="nc" id="L318">        growth.put(&quot;growth&quot;, &quot;+25%&quot;);</span>
<span class="nc" id="L319">        return growth;</span>
    }

    private Map&lt;String, Object&gt; getListingGrowthStats() {
<span class="nc" id="L323">        Map&lt;String, Object&gt; growth = new HashMap&lt;&gt;();</span>
<span class="nc" id="L324">        growth.put(&quot;thisMonth&quot;, 89);</span>
<span class="nc" id="L325">        growth.put(&quot;lastMonth&quot;, 76);</span>
<span class="nc" id="L326">        growth.put(&quot;growth&quot;, &quot;+17%&quot;);</span>
<span class="nc" id="L327">        return growth;</span>
    }

    private Map&lt;String, Object&gt; getActivityStats() {
<span class="nc" id="L331">        Map&lt;String, Object&gt; activity = new HashMap&lt;&gt;();</span>
<span class="nc" id="L332">        activity.put(&quot;dailyActiveUsers&quot;, 45);</span>
<span class="nc" id="L333">        activity.put(&quot;avgSessionDuration&quot;, &quot;12 minutes&quot;);</span>
<span class="nc" id="L334">        activity.put(&quot;bounceRate&quot;, &quot;25%&quot;);</span>
<span class="nc" id="L335">        return activity;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>