<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RetrouvTout Backend</a> &gt; <a href="index.source.html" class="el_package">com.retrouvtout.controller</a> &gt; <span class="el_source">AuthController.java</span></div><h1>AuthController.java</h1><pre class="source lang-java linenums">package com.retrouvtout.controller;

import com.retrouvtout.dto.request.LoginRequest;
import com.retrouvtout.dto.request.RegisterRequest;
import com.retrouvtout.dto.request.RefreshTokenRequest;
import com.retrouvtout.dto.response.AuthResponse;
import com.retrouvtout.dto.response.ApiResponse;
import com.retrouvtout.service.AuthService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import com.retrouvtout.dto.response.ApiResponse;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.web.bind.annotation.*;

import java.io.IOException;

/**
 * Contrôleur pour l'authentification et l'autorisation
 */
@RestController
@RequestMapping(&quot;/auth&quot;)
@Tag(name = &quot;Authentication&quot;, description = &quot;API d'authentification et d'autorisation&quot;)
@CrossOrigin(origins = {&quot;${app.cors.allowed-origins}&quot;})
public class AuthController {

    private final AuthService authService;

    @Autowired
<span class="nc" id="L37">    public AuthController(AuthService authService) {</span>
<span class="nc" id="L38">        this.authService = authService;</span>
<span class="nc" id="L39">    }</span>

    /**
     * Inscription d'un nouvel utilisateur
     */
    @PostMapping(&quot;/register&quot;)
    @Operation(summary = &quot;Inscription d'un nouvel utilisateur&quot;)
    @ApiResponses(value = {
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;201&quot;, description = &quot;Utilisateur créé avec succès&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;400&quot;, description = &quot;Données invalides&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;409&quot;, description = &quot;Email déjà utilisé&quot;)
    })
    public ResponseEntity&lt;ApiResponse&lt;AuthResponse&gt;&gt; register(
            @Valid @RequestBody RegisterRequest registerRequest,
            HttpServletRequest request) {
        
        try {
<span class="nc" id="L56">            AuthResponse authResponse = authService.register(registerRequest, getClientIp(request));</span>
            
<span class="nc" id="L58">            return ResponseEntity.status(HttpStatus.CREATED)</span>
<span class="nc" id="L59">                .body(new ApiResponse&lt;&gt;(</span>
                    true,
                    &quot;Inscription réussie&quot;,
                    authResponse
                ));
<span class="nc" id="L64">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L65">            return ResponseEntity.badRequest()</span>
<span class="nc" id="L66">                .body(new ApiResponse&lt;&gt;(</span>
                    false,
<span class="nc" id="L68">                    e.getMessage(),</span>
                    null
                ));
        }
    }

    /**
     * Connexion d'un utilisateur
     */
    @PostMapping(&quot;/login&quot;)
    @Operation(summary = &quot;Connexion d'un utilisateur&quot;)
    @ApiResponses(value = {
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description = &quot;Connexion réussie&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;401&quot;, description = &quot;Identifiants invalides&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;403&quot;, description = &quot;Compte désactivé&quot;)
    })
    public ResponseEntity&lt;ApiResponse&lt;AuthResponse&gt;&gt; login(
            @Valid @RequestBody LoginRequest loginRequest,
            HttpServletRequest request) {
        
        try {
<span class="nc" id="L89">            AuthResponse authResponse = authService.login(loginRequest, getClientIp(request));</span>
            
<span class="nc" id="L91">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Connexion réussie&quot;,
                authResponse
            ));
<span class="nc" id="L96">        } catch (BadCredentialsException e) {</span>
<span class="nc" id="L97">            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span>
<span class="nc" id="L98">                .body(new ApiResponse&lt;&gt;(</span>
                    false,
                    &quot;Email ou mot de passe incorrect&quot;,
                    null
                ));
<span class="nc" id="L103">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L104">            return ResponseEntity.status(HttpStatus.FORBIDDEN)</span>
<span class="nc" id="L105">                .body(new ApiResponse&lt;&gt;(</span>
                    false,
<span class="nc" id="L107">                    e.getMessage(),</span>
                    null
                ));
        }
    }

    /**
     * Rafraîchissement du token d'accès
     */
    @PostMapping(&quot;/refresh&quot;)
    @Operation(summary = &quot;Rafraîchissement du token d'accès&quot;)
    @ApiResponses(value = {
    @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description =
 &quot;Token rafraîchi avec succès&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;401&quot;, description = &quot;Token de rafraîchissement invalide&quot;)
    })
    public ResponseEntity&lt;ApiResponse&lt;AuthResponse&gt;&gt; refreshToken(
            @Valid @RequestBody RefreshTokenRequest refreshTokenRequest) {
        
        try {
<span class="nc" id="L127">            AuthResponse authResponse = authService.refreshToken(refreshTokenRequest.getRefreshToken());</span>
            
<span class="nc" id="L129">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Token rafraîchi avec succès&quot;,
                authResponse
            ));
<span class="nc" id="L134">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L135">            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span>
<span class="nc" id="L136">                .body(new ApiResponse&lt;&gt;(</span>
                    false,
                    &quot;Token de rafraîchissement invalide&quot;,
                    null
                ));
        }
    }

    /**
     * Déconnexion de l'utilisateur
     */
    @PostMapping(&quot;/logout&quot;)
    @Operation(summary = &quot;Déconnexion de l'utilisateur&quot;)
    @ApiResponses(value = {
    @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description =
&quot;Déconnexion réussie&quot;)
    })
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; logout(
            @RequestHeader(&quot;Authorization&quot;) String authHeader) {
        
        try {
<span class="nc bnc" id="L157" title="All 2 branches missed.">            String token = authHeader.startsWith(&quot;Bearer &quot;) ? </span>
<span class="nc" id="L158">                authHeader.substring(7) : authHeader;</span>
            
<span class="nc" id="L160">            authService.logout(token);</span>
            
<span class="nc" id="L162">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Déconnexion réussie&quot;,
                null
            ));
<span class="nc" id="L167">        } catch (Exception e) {</span>
<span class="nc" id="L168">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Déconnexion réussie&quot;,
                null
            ));
        }
    }

    /**
     * Validation du token d'accès
     */
    @GetMapping(&quot;/validate&quot;)
    @Operation(summary = &quot;Validation du token d'accès&quot;)
    @ApiResponses(value = {
    @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description = 
&quot;Token valide&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;401&quot;, description = &quot;Token invalide&quot;)
    })
    public ResponseEntity&lt;ApiResponse&lt;Boolean&gt;&gt; validateToken(
            @RequestHeader(&quot;Authorization&quot;) String authHeader) {
        
        try {
<span class="nc bnc" id="L190" title="All 2 branches missed.">            String token = authHeader.startsWith(&quot;Bearer &quot;) ? </span>
<span class="nc" id="L191">                authHeader.substring(7) : authHeader;</span>
            
<span class="nc" id="L193">            boolean isValid = authService.validateToken(token);</span>
            
<span class="nc" id="L195">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
<span class="nc bnc" id="L197" title="All 2 branches missed.">                isValid ? &quot;Token valide&quot; : &quot;Token invalide&quot;,</span>
<span class="nc" id="L198">                isValid</span>
            ));
<span class="nc" id="L200">        } catch (Exception e) {</span>
<span class="nc" id="L201">            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span>
<span class="nc" id="L202">                .body(new ApiResponse&lt;&gt;(</span>
                    false,
                    &quot;Token invalide&quot;,
<span class="nc" id="L205">                    false</span>
                ));
        }
    }

    /**
     * Initiation de l'authentification OAuth2 Google
     */
    @GetMapping(&quot;/oauth2/google&quot;)
    @Operation(summary = &quot;Redirection vers l'authentification Google&quot;)
    public void googleOAuth2(HttpServletResponse response) throws IOException {
<span class="nc" id="L216">        String googleAuthUrl = authService.getGoogleAuthUrl();</span>
<span class="nc" id="L217">        response.sendRedirect(googleAuthUrl);</span>
<span class="nc" id="L218">    }</span>

    /**
     * Initiation de l'authentification OAuth2 Facebook
     */
    @GetMapping(&quot;/oauth2/facebook&quot;)
    @Operation(summary = &quot;Redirection vers l'authentification Facebook&quot;)
    public void facebookOAuth2(HttpServletResponse response) throws IOException {
<span class="nc" id="L226">        String facebookAuthUrl = authService.getFacebookAuthUrl();</span>
<span class="nc" id="L227">        response.sendRedirect(facebookAuthUrl);</span>
<span class="nc" id="L228">    }</span>

    /**
     * Callback pour l'authentification OAuth2
     */
    @GetMapping(&quot;/oauth2/callback/{provider}&quot;)
    @Operation(summary = &quot;Callback OAuth2&quot;)
    @ApiResponses(value = {
    @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description = 
&quot;Authentification OAuth2 réussie&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;400&quot;, description = &quot;Erreur d'authentification OAuth2&quot;)
    })
    public ResponseEntity&lt;ApiResponse&lt;AuthResponse&gt;&gt; oauth2Callback(
            @Parameter(description = &quot;Fournisseur OAuth2 (google, facebook)&quot;)
            @PathVariable String provider,
            @RequestParam String code,
            @RequestParam(required = false) String state,
            HttpServletRequest request) {
        
        try {
<span class="nc" id="L248">            AuthResponse authResponse = authService.processOAuth2Callback(</span>
<span class="nc" id="L249">                provider, code, state, getClientIp(request)</span>
            );
            
<span class="nc" id="L252">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Authentification OAuth2 réussie&quot;,
                authResponse
            ));
<span class="nc" id="L257">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L258">            return ResponseEntity.badRequest()</span>
<span class="nc" id="L259">                .body(new ApiResponse&lt;&gt;(</span>
                    false,
<span class="nc" id="L261">                    &quot;Erreur d'authentification OAuth2: &quot; + e.getMessage(),</span>
                    null
                ));
<span class="nc" id="L264">        } catch (Exception e) {</span>
<span class="nc" id="L265">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L266">                .body(new ApiResponse&lt;&gt;(</span>
                    false,
                    &quot;Erreur interne lors de l'authentification OAuth2&quot;,
                    null
                ));
        }
    }

    /**
     * Demande de réinitialisation de mot de passe
     */
    @PostMapping(&quot;/forgot-password&quot;)
    @Operation(summary = &quot;Demande de réinitialisation de mot de passe&quot;)
    @ApiResponses(value = {
    @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description =
&quot;Email de réinitialisation envoyé&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;404&quot;, description = &quot;Utilisateur non trouvé&quot;)
    })
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; forgotPassword(
            @Parameter(description = &quot;Email de l'utilisateur&quot;)
            @RequestParam String email) {
        
        try {
<span class="nc" id="L289">            authService.initiatePasswordReset(email);</span>
            
<span class="nc" id="L291">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Si cet email existe, un lien de réinitialisation a été envoyé&quot;,
                null
            ));
<span class="nc" id="L296">        } catch (Exception e) {</span>
            // Ne pas révéler si l'email existe ou non pour des raisons de sécurité
<span class="nc" id="L298">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Si cet email existe, un lien de réinitialisation a été envoyé&quot;,
                null
            ));
        }
    }

    /**
     * Réinitialisation du mot de passe
     */
    @PostMapping(&quot;/reset-password&quot;)
    @Operation(summary = &quot;Réinitialisation du mot de passe&quot;)
    @ApiResponses(value = {
    @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description = 
 &quot;Mot de passe réinitialisé avec succès&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;400&quot;, description = &quot;Token invalide ou expiré&quot;)
    })
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; resetPassword(
            @Parameter(description = &quot;Token de réinitialisation&quot;)
            @RequestParam String token,
            @Parameter(description = &quot;Nouveau mot de passe&quot;)
            @RequestParam String newPassword) {
        
        try {
<span class="nc" id="L323">            authService.resetPassword(token, newPassword);</span>
            
<span class="nc" id="L325">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Mot de passe réinitialisé avec succès&quot;,
                null
            ));
<span class="nc" id="L330">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L331">            return ResponseEntity.badRequest()</span>
<span class="nc" id="L332">                .body(new ApiResponse&lt;&gt;(</span>
                    false,
<span class="nc" id="L334">                    e.getMessage(),</span>
                    null
                ));
        }
    }

    /**
     * Vérification de l'email
     */
    @GetMapping(&quot;/verify-email&quot;)
    @Operation(summary = &quot;Vérification de l'email&quot;)
    @ApiResponses(value = {
    @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description = 
 &quot;Email vérifié avec succès&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;400&quot;, description = &quot;Token de vérification invalide&quot;)
    })
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; verifyEmail(
            @Parameter(description = &quot;Token de vérification&quot;)
            @RequestParam String token) {
        
        try {
<span class="nc" id="L355">            authService.verifyEmail(token);</span>
            
<span class="nc" id="L357">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Email vérifié avec succès&quot;,
                null
            ));
<span class="nc" id="L362">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L363">            return ResponseEntity.badRequest()</span>
<span class="nc" id="L364">                .body(new ApiResponse&lt;&gt;(</span>
                    false,
<span class="nc" id="L366">                    e.getMessage(),</span>
                    null
                ));
        }
    }

    /**
     * Renvoyer l'email de vérification
     */
    @PostMapping(&quot;/resend-verification&quot;)
    @Operation(summary = &quot;Renvoyer l'email de vérification&quot;)
    @ApiResponses(value = {
    @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description =
&quot;Email de vérification renvoyé&quot;)
    })
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; resendVerificationEmail(
            @Parameter(description = &quot;Email de l'utilisateur&quot;)
            @RequestParam String email) {
        
        try {
<span class="nc" id="L386">            authService.resendVerificationEmail(email);</span>
            
<span class="nc" id="L388">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Email de vérification renvoyé&quot;,
                null
            ));
<span class="nc" id="L393">        } catch (Exception e) {</span>
            // Ne pas révéler si l'email existe ou non
<span class="nc" id="L395">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Si cet email existe et n'est pas encore vérifié, un email a été renvoyé&quot;,
                null
            ));
        }
    }

    /**
     * Obtenir l'adresse IP du client
     */
    private String getClientIp(HttpServletRequest request) {
<span class="nc" id="L407">        String xForwardedFor = request.getHeader(&quot;X-Forwarded-For&quot;);</span>
<span class="nc bnc" id="L408" title="All 4 branches missed.">        if (xForwardedFor != null &amp;&amp; !xForwardedFor.isEmpty()) {</span>
<span class="nc" id="L409">            return xForwardedFor.split(&quot;,&quot;)[0].trim();</span>
        }
        
<span class="nc" id="L412">        String xRealIp = request.getHeader(&quot;X-Real-IP&quot;);</span>
<span class="nc bnc" id="L413" title="All 4 branches missed.">        if (xRealIp != null &amp;&amp; !xRealIp.isEmpty()) {</span>
<span class="nc" id="L414">            return xRealIp;</span>
        }
        
<span class="nc" id="L417">        return request.getRemoteAddr();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>