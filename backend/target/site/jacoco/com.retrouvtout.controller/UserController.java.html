<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RetrouvTout Backend</a> &gt; <a href="index.source.html" class="el_package">com.retrouvtout.controller</a> &gt; <span class="el_source">UserController.java</span></div><h1>UserController.java</h1><pre class="source lang-java linenums">// UserController.java
package com.retrouvtout.controller;

import com.retrouvtout.dto.response.ApiResponse;
import com.retrouvtout.dto.response.PagedResponse;
import com.retrouvtout.dto.response.UserResponse;
import com.retrouvtout.entity.User;
import com.retrouvtout.security.UserPrincipal;
import com.retrouvtout.service.UserService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import com.retrouvtout.dto.response.ApiResponse;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;

/**
 * Contrôleur pour la gestion des utilisateurs
 */
@RestController
@RequestMapping(&quot;/users&quot;)
@Tag(name = &quot;Users&quot;, description = &quot;API de gestion des utilisateurs&quot;)
@CrossOrigin(origins = {&quot;${app.cors.allowed-origins}&quot;})
public class UserController {

    private final UserService userService;

    @Autowired
<span class="nc" id="L40">    public UserController(UserService userService) {</span>
<span class="nc" id="L41">        this.userService = userService;</span>
<span class="nc" id="L42">    }</span>

    /**
     * Obtenir le profil de l'utilisateur connecté
     */
    @GetMapping(&quot;/me&quot;)
    @Operation(summary = &quot;Obtenir mon profil&quot;)
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    @ApiResponses(value = {
    @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description =
&quot;Profil récupéré&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;401&quot;, description = &quot;Non authentifié&quot;)
    })
    @PreAuthorize(&quot;hasRole('USER')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;UserResponse&gt;&gt; getCurrentUser(
            @AuthenticationPrincipal UserPrincipal userPrincipal) {
        
<span class="nc" id="L59">        UserResponse user = userService.getUserById(userPrincipal.getId());</span>
        
<span class="nc" id="L61">        return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
            true,
            &quot;Profil récupéré avec succès&quot;,
            user
        ));
    }

    /**
     * Mettre à jour le profil de l'utilisateur connecté
     */
    @PutMapping(&quot;/me&quot;)
    @Operation(summary = &quot;Mettre à jour mon profil&quot;)
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    @ApiResponses(value = {
    @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description =
&quot;Profil mis à jour&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;400&quot;, description = &quot;Données invalides&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;401&quot;, description = &quot;Non authentifié&quot;)
    })
    @PreAuthorize(&quot;hasRole('USER')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;UserResponse&gt;&gt; updateCurrentUser(
            @RequestBody UpdateUserRequest request,
            @AuthenticationPrincipal UserPrincipal userPrincipal) {
        
        try {
<span class="nc bnc" id="L86" title="All 2 branches missed.">            User.UserRole role = request.getRole() != null ? </span>
<span class="nc" id="L87">                User.UserRole.fromValue(request.getRole()) : null;</span>
            
<span class="nc" id="L89">            UserResponse updatedUser = userService.updateUser(</span>
<span class="nc" id="L90">                userPrincipal.getId(),</span>
<span class="nc" id="L91">                request.getName(),</span>
<span class="nc" id="L92">                request.getPhone(),</span>
                role
            );
            
<span class="nc" id="L96">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Profil mis à jour avec succès&quot;,
                updatedUser
            ));
<span class="nc" id="L101">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L102">            return ResponseEntity.badRequest()</span>
<span class="nc" id="L103">                .body(new ApiResponse&lt;&gt;(</span>
                    false,
<span class="nc" id="L105">                    e.getMessage(),</span>
                    null
                ));
        }
    }

    /**
     * Changer le mot de passe
     */
    @PutMapping(&quot;/me/password&quot;)
    @Operation(summary = &quot;Changer mon mot de passe&quot;)
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    @ApiResponses(value = {
    @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description =
 &quot;Mot de passe changé&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;400&quot;, description = &quot;Ancien mot de passe incorrect&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;401&quot;, description = &quot;Non authentifié&quot;)
    })
    @PreAuthorize(&quot;hasRole('USER')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; changePassword(
            @RequestBody ChangePasswordRequest request,
            @AuthenticationPrincipal UserPrincipal userPrincipal) {
        
        try {
<span class="nc" id="L129">            userService.changePassword(</span>
<span class="nc" id="L130">                userPrincipal.getId(),</span>
<span class="nc" id="L131">                request.getOldPassword(),</span>
<span class="nc" id="L132">                request.getNewPassword()</span>
            );
            
<span class="nc" id="L135">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Mot de passe changé avec succès&quot;,
                null
            ));
<span class="nc" id="L140">        } catch (IllegalArgumentException | IllegalStateException e) {</span>
<span class="nc" id="L141">            return ResponseEntity.badRequest()</span>
<span class="nc" id="L142">                .body(new ApiResponse&lt;&gt;(</span>
                    false,
<span class="nc" id="L144">                    e.getMessage(),</span>
                    null
                ));
        }
    }

    /**
     * Obtenir un utilisateur public par son ID
     */
    @GetMapping(&quot;/{id}/public&quot;)
    @Operation(summary = &quot;Obtenir le profil public d'un utilisateur&quot;)
    @ApiResponses(value = {
    @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;200&quot;, description = 
&quot;Profil public récupéré&quot;),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = &quot;404&quot;, description = &quot;Utilisateur non trouvé&quot;)
    })
    public ResponseEntity&lt;ApiResponse&lt;UserResponse&gt;&gt; getPublicUser(
            @Parameter(description = &quot;ID de l'utilisateur&quot;)
            @PathVariable String id) {
        
        try {
<span class="nc" id="L165">            UserResponse user = userService.getUserById(id);</span>
            // Masquer les informations sensibles pour la version publique
<span class="nc" id="L167">            user.setEmail(null);</span>
<span class="nc" id="L168">            user.setPhone(null);</span>
            
<span class="nc" id="L170">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(</span>
                true,
                &quot;Profil public récupéré&quot;,
                user
            ));
<span class="nc" id="L175">        } catch (Exception e) {</span>
<span class="nc" id="L176">            return ResponseEntity.notFound().build();</span>
        }
    }

    // Classes de requête pour les mises à jour
<span class="nc" id="L181">    public static class UpdateUserRequest {</span>
        private String name;
        private String phone;
        private String role;

        // Getters et setters
<span class="nc" id="L187">        public String getName() { return name; }</span>
<span class="nc" id="L188">        public void setName(String name) { this.name = name; }</span>

<span class="nc" id="L190">        public String getPhone() { return phone; }</span>
<span class="nc" id="L191">        public void setPhone(String phone) { this.phone = phone; }</span>

<span class="nc" id="L193">        public String getRole() { return role; }</span>
<span class="nc" id="L194">        public void setRole(String role) { this.role = role; }</span>
    }

<span class="nc" id="L197">    public static class ChangePasswordRequest {</span>
        private String oldPassword;
        private String newPassword;

        // Getters et setters
<span class="nc" id="L202">        public String getOldPassword() { return oldPassword; }</span>
<span class="nc" id="L203">        public void setOldPassword(String oldPassword) { this.oldPassword = oldPassword; }</span>

<span class="nc" id="L205">        public String getNewPassword() { return newPassword; }</span>
<span class="nc" id="L206">        public void setNewPassword(String newPassword) { this.newPassword = newPassword; }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>