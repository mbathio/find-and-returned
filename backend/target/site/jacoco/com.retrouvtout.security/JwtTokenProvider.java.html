<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JwtTokenProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RetrouvTout Backend</a> &gt; <a href="index.source.html" class="el_package">com.retrouvtout.security</a> &gt; <span class="el_source">JwtTokenProvider.java</span></div><h1>JwtTokenProvider.java</h1><pre class="source lang-java linenums">package com.retrouvtout.security;

import com.auth0.jwt.JWT;
import com.auth0.jwt.JWTVerifier;
import com.auth0.jwt.algorithms.Algorithm;
import com.auth0.jwt.exceptions.JWTVerificationException;
import com.auth0.jwt.interfaces.DecodedJWT;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import java.util.Date;

/**
 * Fournisseur de tokens JWT pour l'authentification
 */
@Component
<span class="nc" id="L17">public class JwtTokenProvider {</span>

    @Value(&quot;${app.jwt.secret}&quot;)
    private String jwtSecret;

    @Value(&quot;${app.jwt.expiration}&quot;)
    private long jwtExpirationInMs;

    @Value(&quot;${app.jwt.refresh-expiration}&quot;)
    private long refreshTokenExpirationInMs;

    private static final String ISSUER = &quot;retrouvtout-api&quot;;
    private static final String AUDIENCE = &quot;retrouvtout-app&quot;;

    /**
     * Générer un token d'accès
     */
    public String generateToken(String userId) {
<span class="nc" id="L35">        Date now = new Date();</span>
<span class="nc" id="L36">        Date expiryDate = new Date(now.getTime() + jwtExpirationInMs);</span>

<span class="nc" id="L38">        Algorithm algorithm = Algorithm.HMAC256(jwtSecret);</span>

<span class="nc" id="L40">        return JWT.create()</span>
<span class="nc" id="L41">                .withIssuer(ISSUER)</span>
<span class="nc" id="L42">                .withAudience(AUDIENCE)</span>
<span class="nc" id="L43">                .withSubject(userId)</span>
<span class="nc" id="L44">                .withIssuedAt(now)</span>
<span class="nc" id="L45">                .withExpiresAt(expiryDate)</span>
<span class="nc" id="L46">                .withClaim(&quot;type&quot;, &quot;access&quot;)</span>
<span class="nc" id="L47">                .sign(algorithm);</span>
    }

    /**
     * Générer un token de rafraîchissement
     */
    public String generateRefreshToken(String userId) {
<span class="nc" id="L54">        Date now = new Date();</span>
<span class="nc" id="L55">        Date expiryDate = new Date(now.getTime() + refreshTokenExpirationInMs);</span>

<span class="nc" id="L57">        Algorithm algorithm = Algorithm.HMAC256(jwtSecret);</span>

<span class="nc" id="L59">        return JWT.create()</span>
<span class="nc" id="L60">                .withIssuer(ISSUER)</span>
<span class="nc" id="L61">                .withAudience(AUDIENCE)</span>
<span class="nc" id="L62">                .withSubject(userId)</span>
<span class="nc" id="L63">                .withIssuedAt(now)</span>
<span class="nc" id="L64">                .withExpiresAt(expiryDate)</span>
<span class="nc" id="L65">                .withClaim(&quot;type&quot;, &quot;refresh&quot;)</span>
<span class="nc" id="L66">                .sign(algorithm);</span>
    }

    /**
     * Générer un token de réinitialisation de mot de passe
     */
    public String generatePasswordResetToken(String userId) {
<span class="nc" id="L73">        Date now = new Date();</span>
<span class="nc" id="L74">        Date expiryDate = new Date(now.getTime() + (60 * 60 * 1000)); // 1 heure</span>

<span class="nc" id="L76">        Algorithm algorithm = Algorithm.HMAC256(jwtSecret);</span>

<span class="nc" id="L78">        return JWT.create()</span>
<span class="nc" id="L79">                .withIssuer(ISSUER)</span>
<span class="nc" id="L80">                .withAudience(AUDIENCE)</span>
<span class="nc" id="L81">                .withSubject(userId)</span>
<span class="nc" id="L82">                .withIssuedAt(now)</span>
<span class="nc" id="L83">                .withExpiresAt(expiryDate)</span>
<span class="nc" id="L84">                .withClaim(&quot;type&quot;, &quot;password_reset&quot;)</span>
<span class="nc" id="L85">                .sign(algorithm);</span>
    }

    /**
     * Générer un token de vérification d'email
     */
    public String generateEmailVerificationToken(String userId) {
<span class="nc" id="L92">        Date now = new Date();</span>
<span class="nc" id="L93">        Date expiryDate = new Date(now.getTime() + (24 * 60 * 60 * 1000)); // 24 heures</span>

<span class="nc" id="L95">        Algorithm algorithm = Algorithm.HMAC256(jwtSecret);</span>

<span class="nc" id="L97">        return JWT.create()</span>
<span class="nc" id="L98">                .withIssuer(ISSUER)</span>
<span class="nc" id="L99">                .withAudience(AUDIENCE)</span>
<span class="nc" id="L100">                .withSubject(userId)</span>
<span class="nc" id="L101">                .withIssuedAt(now)</span>
<span class="nc" id="L102">                .withExpiresAt(expiryDate)</span>
<span class="nc" id="L103">                .withClaim(&quot;type&quot;, &quot;email_verification&quot;)</span>
<span class="nc" id="L104">                .sign(algorithm);</span>
    }

    /**
     * Extraire l'ID utilisateur du token
     */
    public String getUserIdFromToken(String token) {
        try {
<span class="nc" id="L112">            DecodedJWT decodedJWT = verifyToken(token);</span>
<span class="nc" id="L113">            return decodedJWT.getSubject();</span>
<span class="nc" id="L114">        } catch (JWTVerificationException e) {</span>
<span class="nc" id="L115">            throw new IllegalArgumentException(&quot;Token invalide&quot;, e);</span>
        }
    }

    /**
     * Obtenir la date d'expiration du token
     */
    public Date getExpirationFromToken(String token) {
        try {
<span class="nc" id="L124">            DecodedJWT decodedJWT = verifyToken(token);</span>
<span class="nc" id="L125">            return decodedJWT.getExpiresAt();</span>
<span class="nc" id="L126">        } catch (JWTVerificationException e) {</span>
<span class="nc" id="L127">            throw new IllegalArgumentException(&quot;Token invalide&quot;, e);</span>
        }
    }

    /**
     * Valider un token
     */
    public boolean validateToken(String token) {
        try {
<span class="nc" id="L136">            verifyToken(token);</span>
<span class="nc" id="L137">            return true;</span>
<span class="nc" id="L138">        } catch (JWTVerificationException e) {</span>
<span class="nc" id="L139">            return false;</span>
        }
    }

    /**
     * Vérifier et décoder un token
     */
    private DecodedJWT verifyToken(String token) throws JWTVerificationException {
<span class="nc" id="L147">        Algorithm algorithm = Algorithm.HMAC256(jwtSecret);</span>
<span class="nc" id="L148">        JWTVerifier verifier = JWT.require(algorithm)</span>
<span class="nc" id="L149">                .withIssuer(ISSUER)</span>
<span class="nc" id="L150">                .withAudience(AUDIENCE)</span>
<span class="nc" id="L151">                .build();</span>

<span class="nc" id="L153">        return verifier.verify(token);</span>
    }

    /**
     * Obtenir le type de token
     */
    public String getTokenType(String token) {
        try {
<span class="nc" id="L161">            DecodedJWT decodedJWT = verifyToken(token);</span>
<span class="nc" id="L162">            return decodedJWT.getClaim(&quot;type&quot;).asString();</span>
<span class="nc" id="L163">        } catch (JWTVerificationException e) {</span>
<span class="nc" id="L164">            throw new IllegalArgumentException(&quot;Token invalide&quot;, e);</span>
        }
    }

    /**
     * Vérifier si le token est du type spécifié
     */
    public boolean isTokenOfType(String token, String type) {
        try {
<span class="nc" id="L173">            String tokenType = getTokenType(token);</span>
<span class="nc" id="L174">            return type.equals(tokenType);</span>
<span class="nc" id="L175">        } catch (Exception e) {</span>
<span class="nc" id="L176">            return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>